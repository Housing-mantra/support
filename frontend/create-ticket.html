<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Create New Ticket</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#254798", // Deep blue
                        secondary: "#EFF3FC", // Light blue background
                        "background-light": "#F3F5FA",
                        "background-dark": "#0F172A",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1E293B",
                        "text-main-light": "#111827",
                        "text-main-dark": "#F9FAFB",
                        "text-sub-light": "#6B7280",
                        "text-sub-dark": "#9CA3AF",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        'xl': '0.75rem',
                        '2xl': '1rem',
                    },
                },
            },
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark h-screen overflow-hidden flex">
    <!-- Mobile Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"
        onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed md:relative w-64 bg-surface-light dark:bg-surface-dark border-r border-gray-200 dark:border-gray-700 flex flex-col justify-between flex-shrink-0 z-40 md:z-20 h-screen -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="flex-1 flex flex-col">
            <div class="h-20 flex items-center px-6 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                <div class="flex items-center w-full justify-center">
                    <img src="/assets/images/shubham-logo.png" alt="Shubham Logo" class="h-12 w-auto object-contain">
                </div>
            </div>
            <nav class="p-4 space-y-1 flex-1 overflow-y-auto">
                <a class="flex items-center px-4 py-3 text-text-sub-light dark:text-text-sub-dark hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg font-medium transition-colors"
                    href="/">
                    <span class="material-icons-outlined mr-3">home</span>
                    Home
                </a>
                <a class="flex items-center px-4 py-3 bg-secondary dark:bg-blue-900/40 text-primary dark:text-blue-300 rounded-lg font-medium transition-colors shadow-sm"
                    href="/create-ticket.html">
                    <span class="material-icons-outlined mr-3">add_box</span>
                    Create Ticket
                </a>
                <a class="flex items-center px-4 py-3 text-text-sub-light dark:text-text-sub-dark hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg font-medium transition-colors"
                    href="/check-status.html">
                    <span class="material-icons-outlined mr-3">fact_check</span>
                    Check Status
                </a>
                <div class="pt-4 pb-2">
                    <div class="h-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
                </div>
                <a class="flex items-center px-4 py-3 text-text-sub-light dark:text-text-sub-dark hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg font-medium transition-colors"
                    href="#">
                    <span class="material-icons-outlined mr-3">menu_book</span>
                    Knowledge Base
                </a>
                <a class="flex items-center px-4 py-3 text-text-sub-light dark:text-text-sub-dark hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg font-medium transition-colors"
                    href="#">
                    <span class="material-icons-outlined mr-3">policy</span>
                    IT Policy
                </a>
                <a class="flex items-center px-4 py-3 text-text-sub-light dark:text-text-sub-dark hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg font-medium transition-colors"
                    href="#">
                    <span class="material-icons-outlined mr-3">mail_outline</span>
                    Contact Support
                </a>
            </nav>
        </div>
    </aside>
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header
            class="h-20 bg-surface-light dark:bg-surface-dark border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 md:px-8 flex-shrink-0 z-10">
            <div class="flex items-center gap-4">
                <!-- Hamburger Menu Button (Mobile Only) -->
                <button onclick="toggleSidebar()"
                    class="md:hidden p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <span class="material-icons-outlined text-gray-700 dark:text-gray-300">menu</span>
                </button>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 dark:text-white">Create New Ticket</h1>
                    <p class="text-xs text-text-sub-light dark:text-text-sub-dark hidden sm:block">Fill in the details
                        below to submit your request</p>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <button
                    class="flex items-center text-text-sub-light dark:text-text-sub-dark hover:text-gray-900 dark:hover:text-white text-sm font-medium transition-colors">
                    <span class="material-icons-outlined text-lg mr-1.5">help_outline</span>
                    Help Center
                </button>
                <div class="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 hidden sm:block"
                        id="userName">Guest</span>
                    <div onclick="toggleAuthModal()"
                        class="h-9 w-9 bg-green-700 text-white rounded-full flex items-center justify-center text-sm font-medium shadow-sm cursor-pointer hover:ring-2 hover:ring-primary transition-all">
                        <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=10b981" alt="Avatar"
                            class="rounded-full h-full w-full">
                    </div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark p-6 md:p-10">
            <div class="max-w-4xl mx-auto">
                <div class="mb-6">
                    <a class="inline-flex items-center text-sm text-text-sub-light hover:text-primary transition-colors font-medium"
                        href="/">
                        <span class="material-icons-outlined text-base mr-1">arrow_back</span>
                        Back to Dashboard
                    </a>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                    <div class="p-8 md:p-10">
                        <div
                            class="flex items-start md:items-center mb-8 pb-6 border-b border-gray-100 dark:border-gray-700">
                            <div
                                class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-primary dark:text-blue-400 mr-5 flex-shrink-0">
                                <span class="material-icons-outlined text-2xl">edit_note</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Ticket Details</h2>
                                <p class="text-sm text-text-sub-light dark:text-text-sub-dark mt-1">Please provide as
                                    much detail as possible so our team can assist you effectively.</p>
                            </div>
                        </div>
                        <form class="space-y-6" onsubmit="handleSubmit(event)">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                                    for="subject">Subject</label>
                                <input
                                    class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary focus:ring-opacity-50 sm:text-sm py-3 px-4"
                                    id="subject" name="subject"
                                    placeholder="Briefly describe the issue (e.g. Laptop screen flickering)" type="text"
                                    required />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                                        for="category">Department</label>
                                    <select
                                        class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary focus:ring-opacity-50 sm:text-sm py-3 pl-4 pr-10"
                                        id="category" name="category">
                                        <option value="IT Support">IT Support (Admin)</option>
                                        <option value="ERP Support">ERP Support (Lead)</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                                        for="priority">Priority Level</label>
                                    <select
                                        class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary focus:ring-opacity-50 sm:text-sm py-3 pl-4 pr-10"
                                        id="priority" name="priority">
                                        <option value="Low">Low - General Question</option>
                                        <option value="Medium" selected="">Medium - Affects Work</option>
                                        <option value="High">High - Urgent Issue</option>
                                        <option value="Critical">Critical - System Down</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                                    for="description">Description</label>
                                <div class="relative">
                                    <textarea
                                        class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary focus:ring-opacity-50 sm:text-sm py-3 px-4"
                                        id="description" name="description" placeholder="Explain the issue in detail..."
                                        rows="5" required></textarea>
                                </div>
                                <p class="mt-2 text-xs text-text-sub-light dark:text-text-sub-dark text-right">0/500
                                    characters</p>
                            </div>
                            <div>
                                <span
                                    class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Attachments
                                    (Optional)</span>
                                <div
                                    class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors cursor-pointer group">
                                    <div class="space-y-1 text-center">
                                        <div
                                            class="bg-blue-50 dark:bg-gray-700 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                            <span
                                                class="material-icons-outlined text-primary dark:text-blue-400 text-2xl">cloud_upload</span>
                                        </div>
                                        <div class="flex text-sm text-gray-600 dark:text-gray-400 justify-center">
                                            <label
                                                class="relative cursor-pointer rounded-md font-medium text-primary hover:text-blue-600 focus-within:outline-none"
                                                for="file-upload">
                                                <span>Click to upload</span>
                                                <input class="sr-only" id="file-upload" name="file-upload" type="file"
                                                    multiple />
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-500">
                                            PNG, JPG, PDF up to 10MB
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="pt-6 flex items-center justify-end space-x-4 border-t border-gray-100 dark:border-gray-700 mt-8">
                                <button
                                    class="bg-white dark:bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 font-medium py-2.5 px-6 rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200"
                                    type="button" onclick="history.back()">
                                    Cancel
                                </button>
                                <button
                                    class="bg-primary hover:bg-blue-800 text-white font-semibold py-2.5 px-8 rounded-lg shadow-lg hover:shadow-xl hover:shadow-blue-500/20 transition-all duration-200 flex items-center transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                                    type="submit">
                                    <span class="material-icons-outlined text-sm mr-2">send</span>
                                    Submit Ticket
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer
            class="bg-surface-light dark:bg-surface-dark border-t border-gray-200 dark:border-gray-700 py-4 px-8 flex-shrink-0">
            <div
                class="flex flex-col md:flex-row items-center justify-between gap-2 text-sm text-text-sub-light dark:text-text-sub-dark">
                <div class="flex items-center gap-1">
                    <span>Â© 2024</span>
                    <span class="font-semibold text-gray-900 dark:text-white">Shubham EPC Pvt. Ltd.</span>
                    <span>All rights reserved.</span>
                </div>
                <div class="flex items-center gap-1">
                    <span>Powered by</span>
                    <span class="font-semibold text-primary dark:text-blue-400">Helpdesk Pro</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Login/Signup Modal -->
    <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-2xl max-w-md w-full p-8 relative">
            <button onclick="toggleAuthModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <span class="material-icons-outlined">close</span>
            </button>
            <div id="authTabs" class="flex gap-4 mb-6 border-b border-gray-200 dark:border-gray-700">
                <button id="loginTab" onclick="switchAuthTab('login')"
                    class="pb-3 px-4 font-semibold text-primary border-b-2 border-primary">Login</button>
                <button id="signupTab" onclick="switchAuthTab('signup')"
                    class="pb-3 px-4 font-semibold text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Sign
                    Up</button>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome Back!</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Login with your Employee ID</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Employee ID</label>
                    <input type="text" id="loginEmployeeId" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mobile Number</label>
                    <input type="tel" id="loginMobile" required pattern="[0-9]{10}"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="10-digit mobile number">
                </div>
                <button type="submit" id="loginBtn"
                    class="w-full bg-primary hover:bg-blue-800 text-white font-semibold py-3 rounded-lg transition-all">Login</button>
            </form>
            <form id="signupForm" onsubmit="handleSignup(event)" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Create Account</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Register as a new employee</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Employee ID</label>
                    <input type="text" id="signupEmployeeId" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                    <input type="text" id="signupName" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="signupEmail" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mobile Number</label>
                    <input type="tel" id="signupMobile" required pattern="[0-9]{10}"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="10-digit mobile number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Department
                        (Optional)</label>
                    <input type="text" id="signupDepartment"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <button type="submit" id="signupBtn"
                    class="w-full bg-primary hover:bg-blue-800 text-white font-semibold py-3 rounded-lg transition-all">Sign
                    Up</button>
            </form>
            <button id="logoutBtn" onclick="handleLogout()"
                class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition-all mt-4">Logout</button>
        </div>
    </div>

    <script src="/shared/js/api.js"></script>
    <script src="/shared/js/auth.js"></script>
    <script>
        async function handleSubmit(event) {
            event.preventDefault();

            // Check if user is logged in
            if (!requireLogin('Please login to create a ticket')) {
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="material-icons-outlined animate-spin text-[20px] mr-2">refresh</span> Submitting...';

            // Get logged in employee data
            const employee = getLoggedInEmployee();

            // First, get or create a default project
            // For now, we'll create a ticket without project requirement
            // Backend needs to be updated to make project optional OR we need to create a default project

            try {
                // Gather form data to match API expectations
                const formData = new FormData();

                // Employee details (from logged in user)
                formData.append('employeeId', employee.employeeId);
                formData.append('name', employee.name);
                formData.append('email', employee.email);
                formData.append('mobile', employee.mobile);

                // Ticket details
                formData.append('subject', document.getElementById('subject').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('priority', document.getElementById('priority').value);
                formData.append('issueType', document.getElementById('category').value); // Backend expects issueType

                // For now, use a dummy project ID - backend will need to handle this
                // You should either create a default project or make it optional
                formData.append('projectId', '000000000000000000000000'); // Placeholder

                // Handle file attachments if any
                const fileInput = document.getElementById('file-upload');
                if (fileInput.files.length > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('attachments', fileInput.files[i]);
                    }
                }

                const response = await TicketAPI.create(formData);

                if (response.success) {
                    alert('Ticket submitted successfully!');
                    setTimeout(() => {
                        window.location.href = '/check-status.html?query=' + employee.employeeId;
                    }, 1000);
                } else {
                    throw new Error(response.message || 'Failed to create ticket');
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Failed to submit ticket: ' + (error.message || 'Please try again.'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        }
    </script>

    <script>
        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Close sidebar when clicking a link on mobile
        document.querySelectorAll('#sidebar a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });
    </script>
</body>

</html>